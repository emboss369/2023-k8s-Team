---
- name: Setup kubernetes server
  hosts: k3ssv
  gather_facts: true
  become: true

  roles:
    - role: k3s_server
      tags: k3s_server
        
- name: Setup kubernetes agents
  hosts: agents
  gather_facts: true
  become: true

  roles:
    - role: k3s_agent
      tags: k3s_agent

- name: Setup Greengrass Core
  hosts: k3sgw
  gather_facts: true
  become: true

  roles:
    - role: greengrass_setup
      tags: greengrass_setup

- name: Deployment Greengrass Core with kubernetes
  hosts: k3ssv
  gather_facts: true
  become: false

  roles:
    - role: common_settings
    - role: greengrass_deployment
      tags: greengrass_deployment

- name: Setup iot thing
  hosts: k3ssv
  gather_facts: true
  become: false

  roles:
    - role: common_settings
    - role: iot
      tags: iot

- name: Setup iot client
  hosts: k3sds
  gather_facts: true
  become: false

  roles:
    - role: common_settings
    - role: client_setup
      tags: client_setup

- name: Deploy the iot client pod in Kubernetes
  hosts: k3ssv
  gather_facts: true
  become: false

  roles:
    # common_settingsに変数を集約
    - role: common_settings
    - role: client_deployment
      tags: client_deployment